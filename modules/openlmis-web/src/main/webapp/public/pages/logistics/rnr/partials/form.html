<div ng-controller="CreateRnrController" >
<div ng-hide="programRnRColumnList">Loading...</div>
<form name="saveRnrForm" ng-submit="submitRnr()" id="rnr-form" novalidate >
<div class="total-cost alert alert-info">Total R&amp;R Cost:
<span id="totalCostCurrency" class="cell-text">
                                           {{currency}}
                       </span>
                       <span id="totalCost" ng-bind="rnr.totalSubmittedCost"
                             class="cell-text">
                       </span>
   </div>
<div class="rnr-table">
           <table class="table table-striped table-bordered">
               <thead>
               <tr>
                   <th class="col-{{programRnrColumn.name}}" ng-repeat="programRnrColumn in programRnRColumnList" ng-show="showSelectedColumn(programRnrColumn.name)">
                       {{programRnrColumn.label}}
                   </th>
               </tr>
               </thead>
               <tbody ng-show="programRnRColumnList && (rnr.lineItems.length > 0)">
          <tr ng-repeat = "rnrLineItem in rnrLineItems" ng-class="getRowErrorClass(rnrLineItem,programRnRColumnList)">
            <td class = "cell-input" ng-repeat = "column in programRnRColumnList"
                ng-show = "showSelectedColumn(column.name)" >
                       <ng-switch on="column.source.name">
                           <span ng-switch-when="USER_INPUT">
                               <ng-switch on="column.name">
                         <span ng-switch-when = "beginningBalance" ng-class="getCellErrorClass(rnrLineItem, programRnRColumnList)">
                                     <input  id="{{getId('A', $parent)}}" type="text"
                                             ng-required="true" ng-disabled="disableFormForSubmittedRnr()"
                                            name="beginningBalance{{rnrLineItem.rnrLineItem['id']}}"
                                            ng-model="rnrLineItem.rnrLineItem[column.name]"
                                            rnr-validator="positiveInteger" maxlength="8"
                                            ng-change="rnrLineItem.fill(rnr, programRnRColumnList)" ng-class="highlightRequired(rnrLineItem.rnrLineItem[column.name])"/>
                                     <span class="rnr-form-error" id="beginningBalance{{rnrLineItem.rnrLineItem['id']}}" style="display:none;">
                                      Enter Numeric Data
                                     </span>
                           <span class="row-specific-error" ng-show="rnrLineItem.getErrorMessage(programRnRColumnList)" style="background: red;">
                            {{rnrLineItem.getErrorMessage(programRnRColumnList)}}
                            <span class="beak-down"></span>
                           </span >
                         </span>

                         <span ng-switch-when = "quantityReceived" ng-class="getCellErrorClass(rnrLineItem, programRnRColumnList)" >
                             <input ng-required = "true" ng-disabled = "disableFormForSubmittedRnr()"
                                    id = "{{getId('B', $parent)}}" type = "text"
                                              name="quantityReceived{{rnrLineItem.rnrLineItem['id']}}"
                                              ng-model="rnrLineItem.rnrLineItem[column.name]"
                                              rnr-validator="positiveInteger" maxlength="8"
                                              ng-change="rnrLineItem.fill(rnr, programRnRColumnList)"
                                              ng-class="highlightRequired(rnrLineItem.rnrLineItem[column.name])"/>
                                       <span class="rnr-form-error" id="quantityReceived{{rnrLineItem.rnrLineItem['id']}}" style="display:none;">
                                        Enter Numeric Data
                                       </span>
                            <span class="row-specific-error" ng-show="rnrLineItem.getErrorMessage(programRnRColumnList)" style="background: red;">
                            {{rnrLineItem.getErrorMessage(programRnRColumnList)}}
                            <span class="beak-down"></span>
                           </span >
                         </span >

                         <span ng-switch-when = "quantityDispensed" ng-class="getCellErrorClass(rnrLineItem, programRnRColumnList)" >
                           <input ng-required = "true" ng-disabled = "disableFormForSubmittedRnr()"
                                  id = "{{getId('C', $parent)}}" type = "text"
                                            name="quantityDispensed{{rnrLineItem.rnrLineItem['id']}}"
                                            ng-model="rnrLineItem.rnrLineItem[column.name]"
                                            rnr-validator="positiveInteger"
                                            ng-change="rnrLineItem.fill(rnr, programRnRColumnList)"
                                            maxlength="8"
                                            ng-class="highlightRequired(rnrLineItem.rnrLineItem[column.name])"/>
                                     <span class="rnr-form-error" id="quantityDispensed{{rnrLineItem.rnrLineItem['id']}}" style="display:none;">
                                      Enter Numeric Data
                                     </span>
                            <span class="row-specific-error" ng-show="rnrLineItem.getErrorMessage(programRnRColumnList)" style="background: red;">
                            {{rnrLineItem.getErrorMessage(programRnRColumnList)}}
                            <span class="beak-down"></span>
                           </span >
                         </span >

                                   <span ng-switch-when="lossesAndAdjustments">
                                   <div id="lossesAndAdjustments" class="fade ng-pristine ng-valid modal hide" ui-modal
                                        ng-model="lossesAndAdjustmentsModal[rnrLineItem.rnrLineItem.id]">
                                       <div class="modal-header"><h3>Losses And Adjustments</h3></div>
                                       <div class="modal-body">
                                         <div class="adjustment-field">
                                           <h5>Add new Loss/Adjustment</h5>
                                           <select ng-disabled="disableFormForSubmittedRnr()" ng-model="lossAndAdjustment.type" ng-options="i as i.description for i in lossesAndAdjustmentTypesToDisplay">
                                             <option value="">--Select Type--</option>
                                           </select>
                                           <input ng-disabled="disableFormForSubmittedRnr()" type="text" name="quantity{{rnrLineItem.rnrLineItem.id}}" ng-model="lossAndAdjustment.quantity"
                                                  rnr-validator="positiveInteger" maxlength="8" placeholder="Quantity" />
                                         <div class="rnr-form-error"
                                              id="quantity{{rnrLineItem.rnrLineItem.id}}"
                                               style="display:none;">
                                                       Enter Numeric Data
                                                       </div>
                                           <input type="button" ng-click="addLossAndAdjustment(rnrLineItem,lossAndAdjustment)"
                                                  ng-disabled="!(lossAndAdjustment.type && lossAndAdjustment.quantity)"
                                                  class="btn btn-primary" value="Add" />
                                         </div>
                                         <hr ng-show="rnrLineItem.rnrLineItem.lossesAndAdjustments.length > 0" />
                                         <div class="adjustment-list" ng-show="rnrLineItem.rnrLineItem.lossesAndAdjustments.length > 0">
                                           <ul>
                                             <li ng-repeat="oneLossAndAdjustment in rnrLineItem.rnrLineItem.lossesAndAdjustments" class="clearfix">
                                               <span class="tpl-adjustment-type">
                                                 {{oneLossAndAdjustment.type.description}}
                                               </span>
                                               <span class="tpl-adjustment-delete">
                                                 <a class="close"
                                                    ng-click="removeLossAndAdjustment(rnrLineItem,oneLossAndAdjustment)">&times;</a>
                                               </span>
                                               <span class="tpl-adjustment-qty">
                                                 <input ng-disabled="disableFormForSubmittedRnr()" id="{{getId('D', $parent, true)}}" name="{{oneLossAndAdjustment.type.displayOrder}}"
                                                              type="text"
                                                              ng-model="oneLossAndAdjustment.quantity"
                                                              ng-change="rnrLineItem.reEvaluateTotalLossesAndAdjustments()"
                                                              rnr-validator="positiveInteger"
                                                              maxlength="8"
                                                              />
                                                 <span class="rnr-form-error" id="{{oneLossAndAdjustment.type.displayOrder}}"
                                                       style="display:none;">
                                                       Enter Numeric Data
                                                       </span>
                                               </span>
                                             </li>
                                           </ul>
                                         </div>

                                         <div class="adjustment-total clearfix alert alert-warning" ng-show="rnrLineItem.rnrLineItem.lossesAndAdjustments.length > 0">
                                           <span class="pull-left">Total</span> {{rnrLineItem.rnrLineItem.totalLossesAndAdjustments}}
                                         </div>
                                       </div>
                                       <div class="modal-footer">
                                           <a class="btn btn-success save-button" ng-click="rnrLineItem.fill(rnr, programRnRColumnList)" data-dismiss="modal">Done</a>
                                       </div>
                                   </div>
                                      <a ng-click="showLossesAndAdjustmentModalForLineItem(rnrLineItem.rnrLineItem)" class="rnr-adjustment">
                                        <span class="adjustment-value">
                                          {{rnrLineItem.rnrLineItem.totalLossesAndAdjustments}}</span>
                                      </a>
                                   </span>


                         <span ng-switch-when = "stockInHand" ng-class="getCellErrorClass(rnrLineItem, programRnRColumnList)">
                           <input ng-required = "true" ng-disabled = "disableFormForSubmittedRnr()"
                                  id = "{{getId('E', $parent)}}" type = "text"
                                  name = "stockInHand{{rnrLineItem.rnrLineItem['id']}}"
                                            ng-model="rnrLineItem.rnrLineItem[column.name]"
                                            rnr-validator="positiveInteger"
                                            ng-change="rnrLineItem.fill(rnr, programRnRColumnList)" maxlength="8"
                                            ng-class="highlightRequired(rnrLineItem.rnrLineItem[column.name])"/>
                                     <span class="rnr-form-error" id="stockInHand{{rnrLineItem.rnrLineItem['id']}}" style="display:none;">
                                      Enter Numeric Data
                                     </span>
                            <span class="row-specific-error" ng-show="rnrLineItem.getErrorMessage(programRnRColumnList)" style="background: red;">
                            {{rnrLineItem.getErrorMessage(programRnRColumnList)}}
                            <span class="beak-down"></span>
                           </span >
                         </span >

                                   <span ng-switch-when="newPatientCount">
                                     <input ng-required="true" ng-disabled="disableFormForSubmittedRnr()" id="{{getId('F', $parent)}}" type="text"
                                            name="newPatientCount{{rnrLineItem.rnrLineItem['id']}}"
                                            ng-model="rnrLineItem.rnrLineItem[column.name]"
                                            rnr-validator="positiveInteger" maxlength="8"
                                            ng-change="rnrLineItem.fill(rnr, programRnRColumnList)"
                                            ng-class="highlightRequired(rnrLineItem.rnrLineItem[column.name])"/>
                                     <span class="rnr-form-error" id="newPatientCount{{rnrLineItem.rnrLineItem['id']}}" style="display:none;">
                                      Enter Numeric Data
                                     </span>
                                   </span>

                                   <span ng-switch-when="quantityRequested">
                                     <input ng-disabled="disableFormForSubmittedRnr()" id="{{getId('J', $parent)}}" type="text"
                                            name="quantityRequested{{rnrLineItem.rnrLineItem['id']}}"
                                            ng-model="rnrLineItem.rnrLineItem[column.name]"
                                            rnr-validator="positiveInteger" maxlength="8"
                                            ng-change="rnrLineItem.fill(rnr, programRnRColumnList)"/>
                                     <span class="rnr-form-error" id="quantityRequested{{rnrLineItem.rnrLineItem['id']}}" style="display:none;">
                                      Enter Numeric Data
                                     </span>
                                   </span>

                                   <span ng-switch-when="quantityApproved">
                                     <input  id="{{getId('K', $parent)}}" type="text"
                                            name="quantityApproved{{rnrLineItem.rnrLineItem['id']}}"
                                            ng-model="rnrLineItem.rnrLineItem[column.name]"
                                            rnr-validator="positiveInteger" maxlength="8"/>
                                     <span class="rnr-form-error" id="quantityApproved{{rnrLineItem.rnrLineItem['id']}}" style="display:none;">
                                      Enter Numeric Data
                                     </span>
                                   </span>

                                   <span ng-switch-when="remarks">
                                       <input ng-disabled="disableFormForSubmittedRnr()" id="{{getId('L', $parent)}}" type="text" name="remarks{{rnrLineItem.rnrLineItem['id']}}"
                                             ng-model="rnrLineItem.rnrLineItem[column.name]"
                                             maxlength="250"/>
                                   </span>


                                   <span ng-switch-when="reasonForRequestedQuantity">
                                       <input ng-disabled="disableFormForSubmittedRnr()" id="{{getId('W', $parent)}}" type="text"
                                            name="reasonForRequestedQuantity{{rnrLineItem.rnrLineItem['id']}}"
                                            ng-model="rnrLineItem.rnrLineItem[column.name]"
                                            ng-required="rnrLineItem.rnrLineItem.quantityRequested"
                                            ng-class="highlightWarning(rnrLineItem.rnrLineItem[column.name],$parent.$parent.$parent.$index )"
                                            maxlength="250"/>
                                          <span class="alert alert-warning reason-request" ng-show="rnrLineItem.rnrLineItem.quantityRequested && !rnrLineItem.rnrLineItem.reasonForRequestedQuantity">
                                          Please enter a reason
                                        </span>
                                   </span>

                                   <span ng-switch-when="stockOutDays">
                                       <input ng-required="true" ng-disabled="disableFormForSubmittedRnr()" id="{{getId('X', $parent)}}" type="text" name="stockOutDays{{rnrLineItem.rnrLineItem['id']}}"
                                       ng-model="rnrLineItem.rnrLineItem[column.name]"
                                       rnr-validator="positiveInteger" maxlength="8"
                                       ng-change="rnrLineItem.fill(rnr, programRnRColumnList)"
                                       ng-class="highlightRequired(rnrLineItem.rnrLineItem[column.name])"/>
                                       <span class="rnr-form-error" id="stockOutDays{{rnrLineItem.rnrLineItem['id']}}" style="display:none;">
                                       Enter Numeric Data
                                       </span>
                                   </span>
                               </ng-switch>
                           </span>
                           <span ng-switch-default>
                               <ng-switch on="column.name">
                        <span ng-switch-when = "stockInHand" ng-class="getCellErrorClass(rnrLineItem, programRnRColumnList)">
                          <span id = "{{column.indicator+'_'+$parent.$parent.$index}}"
                                ng-bind = "rnrLineItem.rnrLineItem[column.name]"
                                class = "cell-text" >
                          </span >
                           <span class="row-specific-error" ng-show="rnrLineItem.getErrorMessage(programRnRColumnList)" style="background: red;">
                            {{rnrLineItem.getErrorMessage(programRnRColumnList)}}
                            <span class="beak-down"></span>
                           </span >
                        </span>
                                   <span ng-switch-when="price">
                                       <span id="{{'priceCurrency_'+$parent.$parent.$index}}" class="cell-text" ng-show="showCurrencySymbol(rnrLineItem.rnrLineItem[column.name])">
                                           {{currency}}
                                       </span>
                                       <span id="{{column.indicator+'_'+$parent.$parent.$index}}" ng-bind="rnrLineItem.rnrLineItem[column.name]"
                                           class="cell-text">
                                       </span>
                                   </span>
                                   <span ng-switch-when="cost">
                                       <span id="{{'costCurrency_'+$parent.$parent.$index}}" class="cell-text" ng-show="showCurrencySymbol(rnrLineItem.rnrLineItem[column.name])" >
                                           {{currency}}
                                       </span>
                                       <span id="{{column.indicator+'_'+$parent.$parent.$index}}" ng-bind="rnrLineItem.rnrLineItem[column.name]"
                                           class="cell-text">
                                       </span>
                                   </span>
                                    <span id="{{column.indicator+'_'+$parent.$parent.$index}}" ng-bind="rnrLineItem.rnrLineItem[column.name]"
                                          class="cell-text" ng-switch-default>
                                    </span>
                               </ng-switch>
                           </span>
                       </ng-switch>
                   </td>
               </tr>

               </tbody>
           </table>

   </div>
   <br />
  <div id="action_buttons" class="action-buttons">
      <div class="form-cell button-row">
        <input ng-disabled="disableFormForSubmittedRnr()" type="button" ng-click="saveRnr()" class="btn btn-primary save-button" value="Save"/>
        <input ng-show="rnr.status == 'INITIATED'" ng-disabled="disableFormForSubmittedRnr()" type="submit" class="btn btn-success submit-button" value="Submit"/>
        <input type="button" ng-show="rnr.status == 'SUBMITTED'" ng-click="authorizeRnr()" class="btn btn-success submit-button" value="Authorize"/>
      </div>
  <div class="toolbar-error" id="saveFailMessage" ng-model="error" ng-show="error && !submitError && !submitMessage">
    {{error}}
  </div>
    <div class="toolbar-error" id="submitFailMessage" ng-model="submitError" ng-show="submitError">
      {{submitError}}
    </div>
  <div class="toolbar-success" id="saveSuccessMsgDiv" ng-model="message" ng-show="!submitMessage && !submitError && message">
    {{message}}
  </div>
    <div class="toolbar-success" id="submitSuccessMsgDiv" ng-model="submitMessage" ng-show="submitMessage">
      {{submitMessage}}
    </div>
   </div>
</form>
 </div>
